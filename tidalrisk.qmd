---
title: "Density of tidal wetlands at risk on the Gulf Coast"
author: 
  - name: Marcus Beck, <mbeck@tbep.org>
institute: "Tampa Bay Estuary Program"
date: "`r Sys.Date()`"
format:
  html:
    theme: cosmo
    code-tools: 
      source: https://github.com/tbep-tech/wetlands-eval/blob/main/tidalrisk.qmd
code-fold: true
execute:
  echo: true
  warning: false
---

```{r}
library(tidyverse)
library(USA.state.boundaries)
library(mapedit)
library(mapview)
library(sf)
library(lwgeom)
library(here)
library(MASS)
library(terra)
library(tmap)
library(MASS)

gulfsta <- c('FL', 'AL', 'MS', 'LA', 'TX')

##
# create gulf coastline buffer

data("state_boundaries_wgs84")

gulfstates <- state_boundaries_wgs84 %>%
  filter(STATE_ABBR %in% gulfsta) %>%
  st_union() %>%
  st_sf() %>%
  st_cast('POLYGON') %>%
  mutate(
    area = st_area(.)
  ) %>%
  filter(area == max(area)) %>%
  st_cast('LINESTRING') %>%
  st_transform(crs = 5070)

# m <- mapview(gulfstates)
# x <- drawFeatures(m, record = T)

crds <- tibble(
    lat = c(25.957684, 25.292464),
    lon = c(-97.146313, -80.39113)
  ) %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>%
  st_transform(st_crs(gulfstates)) %>%
  st_snap(gulfstates, tolerance = 100)

coast <- st_split(gulfstates$geometry, crds$geometry) %>%
  st_collection_extract("LINESTRING") %>%
  st_sf() %>%
  .[c(1, 3),] %>%
  st_union() %>%
  st_sf()

coastbuff <- st_buffer(coast, dist = 100000)

##
# get wetlands in gulf states

fls <- list.files('data', pattern = paste(gulfsta, collapse = '|'), full.names = T)

ests <- NULL
for(fl in fls){

  # load file

  load(here(fl))
  nm <- gsub('\\.RData$', '', basename(fl))
  wetdat <- get(nm)

  # get isolated

  out <- wetdat %>%
    filter(ACRES >= 0.25) %>%
    filter(!WETLAND_TYPE %in% 'Estuarine and Marine Deepwater') %>%
    mutate(
      isolated = as.numeric(neardist) >= 50,
      state = gsub('^wet', '', nm)
    ) %>%
    filter(isolated)

  ests <- rbind(ests, out)

}

##
# get point density

tomap <- ests %>%
  st_as_sf(coords = c('LON', 'LAT'), crs = 4326) %>%
  filter(WETLAND_TYPE == 'Estuarine and Marine Wetland')

pts <- tomap %>%
  st_transform(crs = st_crs(coast)) %>%
  st_coordinates() %>%
  as_tibble()

nbin <- 1000
hin <- c(width.SJ(pts$X, nb = nbin, method = 'dpi'), width.SJ(pts$Y, nb = nbin, method = 'dpi'))
int <- MASS::kde2d(pts$X, pts$Y, h = hin, n = 1000)

df <- expand.grid(x = int$x, y = int$y, KEEP.OUT.ATTRS = FALSE)
df$z <- as.vector(int$z) * 1e11
denrest <- rast(df)

denmask <- mask(denrest, coastbuff)
crs(denmask) <- 'epsg:5070'

##
# create tmap leaflet

tmrast <- tm_shape(as(denmask, "Raster")) +
  tm_raster(n = 20, palette = rev(viridisLite::viridis(20)),
            alpha = 0.7)
tmap_leaflet(
  tmrast
)
```
